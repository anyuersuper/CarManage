<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工单管理</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* 全局样式 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f8fa;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 导航栏样式 */
        .navbar {
            width: 100%;
            background-color: #007bff;
            padding: 15px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            gap: 20px;
            position: relative;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 30px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .navbar a:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .navbar .logout-btn {
            background-color: #dc3545;
            position: absolute;
            right: 20px;
        }

        .navbar .logout-btn:hover {
            background-color: #c82333;
        }

        /* 页面内容 */
        .container {
            width: 80%;
            max-width: 1200px;
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #greeting {
            font-size: 20px;
            margin-bottom: 30px;
        }

        /* 搜索框样式 */
        .search-box {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .search-box select, .search-box input {
            padding: 8px;
            width: 250px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .search-box button {
            padding: 8px 16px;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .search-box button:hover {
            background-color: #0056b3;
        }

        /* 表格样式 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 12px;
            text-align: center;
            word-wrap: break-word;
            max-width: 200px; /* 限制每列最大宽度 */
        }

        /* 强制让超出内容部分截断显示，并使用省略号 */
        td.content {
            max-height: 100px; /* 设置最大高度 */
            overflow: hidden; /* 超出部分隐藏 */
            text-overflow: ellipsis; /* 超过宽度部分使用省略号显示 */
            white-space: nowrap; /* 防止超出部分换行 */
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        /* 修复按钮和下拉框样式 */
        td select, td button {
            width: 100%;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        /* 分页样式 */
        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }

        .pagination button {
            padding: 8px 16px;
            margin: 0 5px;
            border: 1px solid #ddd;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .pagination button:hover {
            background-color: #0056b3;
        }

        .pagination button.disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* 按钮容器样式 */
        .button-container {
            display: flex;
            gap: 10px; /* 按钮之间的间距 */
            justify-content: flex-start; /* 按钮左对齐 */
        }

        /* 修改按钮 */
        .btn-edit {
            padding: 6px 12px;
            margin: 3px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-edit:hover {
            background-color: #218838;
        }

        /* 查看按钮 */
        .btn-view {
            padding: 6px 12px;
            margin: 3px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-view:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <!-- 导航栏 -->
    <div class="navbar">
        <a href="/home.html">首页</a>
		<a id="user-management-link" href="/usermanage.html" style="display:none;">用户管理</a>
        <a href="/carmanage.html">车辆管理</a>
        <a href="/ordermanage.html">账单管理</a>
        <a href="/workordermanage.html">工单管理</a>
        <a href="/submanage.html">申请管理</a>
        <a href="javascript:void(0);" class="logout-btn" onclick="logout()">退出登录</a>
    </div>

    <!-- 页面主要内容 -->
    <div class="container">
        <h1 id="greeting"></h1>

        <!-- 搜索框 -->
        <div class="search-box">
            <select id="search-field">
                <option value="workorderid">工单ID</option>
                <option value="uid">用户ID</option>
                <option value="cmuid">维修员工ID</option>
                <option value="status">状态</option>
            </select>
            <input type="text" id="search-input" placeholder="请输入搜索内容" />
            <button onclick="searchApplications()">搜索</button>
        </div>

        <!-- 工单管理表格 -->
        <table id="workorder-table">
            <thead>
                <tr>
                    <th>工单ID</th>
                    <th>用户ID</th>
                    <th>维修员工ID</th>
                    <th>开始时间</th>
                    <th>完成时间</th>
                    <th>状态</th>
                    <th id="operation-column">操作</th> <!-- 操作列默认隐藏 -->
                </tr>
            </thead>
            <tbody>
                <!-- 静态数据行 -->
            </tbody>
        </table>

        <!-- 分页控件 -->
        <div class="pagination">
            <button id="prev-page" onclick="changePage(-1)" class="disabled">上一页</button>
            <button id="next-page" onclick="changePage(1)">下一页</button>
        </div>
    </div>

    <script>
		// 每页显示10条数据
		const itemsPerPage = 10;
		let currentPage = 1;
		let allApplications = []; // 存储所有工单数据
		let filteredApplications = []; // 存储过滤后的工单数据

		// 加载工单数据（从后端获取）
		function loadApplications(page) {
		    $.ajax({
		        url: "/cmworkorder/myworkorder",
		        method: "GET",
		        dataType: "json",
		        success: function (data) {
		            allApplications = data;  // 保存所有工单数据
		            if (filteredApplications.length === 0) {  // 如果没有搜索条件，加载所有数据
		                filteredApplications = allApplications;
		            }
		            renderTable(filteredApplications); // 渲染工单表格
		            updatePagination(page); // 更新分页
		        },
		        error: function () {
		            alert("获取工单数据失败！");
		        }
		    });
		}

		// 渲染工单表格
		function renderTable(data) {
		    let tbody = $("#workorder-table tbody");
		    tbody.empty();

		    data.forEach(function (application) {
		        // 将时间字符串转化为中国时区时间
		        const startTime = new Date(application.starttime);
		        const finishedTime = new Date(application.finishedtime);
		        
		        // 转换为中国时间（UTC+8）
		        const startTimeCST = startTime.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
		        const finishedTimeCST = finishedTime.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });

		        let statusOptions = `
		            <select class="status-dropdown">
		                <option value="处理中" ${application.status === '处理中' ? 'selected' : ''}>处理中</option>
		                <option value="已完成" ${application.status === '已完成' ? 'selected' : ''}>已完成</option>
		            </select>
		        `;
		        
		        let row = `<tr>
		            <td>${application.workorderid}</td>
		            <td>${application.uid}</td>
		            <td>${application.cmuid}</td>
		            <td>${startTimeCST}</td>
		            <td>${finishedTimeCST}</td>
		            <td>${statusOptions}</td>
					<td>
					    <div class="button-container">
					        <button class="btn btn-edit" onclick="editApplication(${application.workorderid})">修改</button>
					        <button class="btn btn-view" onclick="deleteApplication(${application.workorderid})">删除</button>  <!-- 删除按钮 -->
					    </div>
					</td>

		        </tr>`;

		        tbody.append(row);
		    });
		}


		// 根据搜索条件过滤工单数据
		function filterApplications() {
		    const searchField = $("#search-field").val(); // 获取选择的字段
		    const searchText = $("#search-input").val().toLowerCase(); // 获取输入框的内容

		    // 过滤工单数据
		    filteredApplications = allApplications.filter(function(application) {
		        return application[searchField] && application[searchField].toString().toLowerCase().includes(searchText);
		    });
		}

		// 搜索工单
		function searchApplications() {
		    currentPage = 1; // 每次搜索时，页码重新置为第一页
		    filterApplications(); // 过滤工单数据
		    renderTable(filteredApplications); // 渲染过滤后的数据
		    updatePagination(currentPage); // 更新分页按钮
		}

		// 更新分页按钮状态
		function updatePagination(page) {
		    const totalPages = Math.ceil(filteredApplications.length / itemsPerPage);
		    $("#prev-page").toggleClass("disabled", page === 1);
		    $("#next-page").toggleClass("disabled", page === totalPages);
		}

		// 分页控制
		function changePage(direction) {
		    const newPage = currentPage + direction;
		    if (newPage < 1 || newPage > Math.ceil(filteredApplications.length / itemsPerPage)) return;
		    currentPage = newPage;
		    loadApplications(currentPage);
		}

		// 修改按钮点击事件
		function editApplication(workorderid) {
		    alert(`修改工单ID: ${workorderid}`);
		}

		// 删除按钮点击事件
		function deleteApplication(workorderid) {
		    // 提示用户确认删除
		    const isConfirmed = confirm(`确定要删除工单ID: ${workorderid} 吗？`);

		    // 如果用户点击“确定”
		    if (isConfirmed) {
		        // 发送删除请求
		        $.ajax({
		            url: `/cmworkorder/delete/${workorderid}`,  // 发送 GET 请求到后端删除接口
		            method: "GET",
		            success: function(response) {
		                // 删除成功后
		                alert(`工单ID: ${workorderid} 删除成功！`);
		                
		                // 从 allApplications 和 filteredApplications 中移除删除的工单
		                allApplications = allApplications.filter(application => application.workorderid !== workorderid);
		                filteredApplications = filteredApplications.filter(application => application.workorderid !== workorderid);

		                // 重新加载工单数据
		                loadApplications(currentPage);  // 重新加载当前页的工单数据
		            },
		            error: function() {
		                alert("删除工单失败！");
		            }
		        });
		    }
		}




		// 退出登录功能
		function logout() {
		    // 删除 cookies
		    document.cookie = "isLoggedIn=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
		    document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
		    // 跳转到登录页面
		    window.location.href = "/index.html";
		}

		// 页面初始化
		$(document).ready(function () {
		    checkLogin();  // 检查登录状态
		    loadApplications(currentPage);  // 加载工单数据
		});

		// 登录状态检查
		function checkLogin() {
		    // 获取所有的 cookies
		    let cookies = document.cookie.split('; ');

		    // 查找 isLoggedIn 和 username cookie
		    let isLoggedIn = cookies.find(cookie => cookie.startsWith('isLoggedIn='));
		    let username = cookies.find(cookie => cookie.startsWith('username='));

		    // 如果没有登录，跳转到登录页面
		    if (!isLoggedIn) {
		        window.location.href = "/index.html";  // 跳转到登录页面
		    } else {
		        // 如果已登录，显示用户名
		        if (username) {
		            let usernameValue = username.split('=')[1];
		            document.getElementById('greeting').innerText = `${usernameValue}，你好！`;

		            // 如果是 admin，显示 "用户管理" 链接
		            if (usernameValue === "admin") {
		                document.getElementById('user-management-link').style.display = "inline-block";
		            }
		        }
		    }
		}

	</script>

</body>
</html> 